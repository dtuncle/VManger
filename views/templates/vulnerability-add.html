{% extends "layout.html" %}

{% block css %}
    <link rel="stylesheet" type="text/css" href="/static/simditor/site/assets/styles/simditor.css"/>

{% endblock %}
{% block js %}
    <script type="text/javascript" src="/static/simditor/site/assets/scripts/jquery.min.js"></script>


    <script type="text/javascript" src="/static/simditor/site/assets/scripts/module.js"></script>
    <script type="text/javascript" src="/static/simditor/site/assets/scripts/hotkeys.js"></script>
    <script type="text/javascript" src="/static/simditor/site/assets/scripts/uploader.js"></script>
    <script type="text/javascript" src="/static/simditor/site/assets/scripts/simditor.js"></script>
{% endblock %}
{% block webinfo %}
    <div class="x-body">
        <form class="layui-form">


            <div class="layui-form-item" id="x-city">

                <div class="layui-form-item">
                    <label for="username" class="layui-form-label">
                        <span class="x-red">*</span>漏洞类型
                    </label>
                    <div class="layui-input-inline">

                        <select name="vultype" lay-filter="province">
                            <option value="">选择漏洞类型</option>
                        </select>

                    </div>
                </div>
                <div class="layui-form-item">
                    <label for="phone" class="layui-form-label">
                        <span class="x-red">*</span>漏洞名称
                    </label>

                    <div class="layui-input-inline">
                        <select name="vulname" lay-filter="city">
                            <option value="">请选漏洞名称</option>
                        </select>

                    </div>
                </div>
                <div class="layui-form-item">
                    <label for="phone" class="layui-form-label">
                        <span class="x-red">*</span>危害等级
                    </label>
                    <div class="layui-input-inline">
                        <select name="rank" lay-filter="area">
                            <option value="">请选择危害</option>
                        </select>
                    </div>
                </div>


            </div>


            <div class="layui-form-item layui-form-text">
                <label for="desc" class="layui-form-label">
                    漏洞详情
                </label>
                <div class="layui-input-block">
                    <textarea id="editor123" name="info" autofocus></textarea>
                </div>
            </div>

            <div class="layui-form-item layui-form-text">
                <label for="desc" class="layui-form-label">
                    修改建议
                </label>
                <div class="layui-input-block">
                    <textarea lay-filter="sugess" id="desc" name="sugess" class="layui-textarea"></textarea>
                </div>
            </div>
            <div class="layui-form-item">
                <label for="L_repass" class="layui-form-label">
                </label>
                <button class="layui-btn" lay-filter="add" lay-submit="">
                    增加
                </button>
                <a class="layui-btn" lay-filter="" lay-submit="">
                    关闭
                </a>
                <a class="layui-btn" lay-filter="" lay-submit="">
                    删除
                </a>
            </div>


        </form>


    </div>
    <script>
        $.fn.xcity = function (pName, cName, aName) {

            var p = $(this).find('select[lay-filter=province]');

            var c = $(this).find('select[lay-filter=city]');

            var a = $(this).find('select[lay-filter=area]');

            var fo =$('textarea[lay-filter=sugess]');

            var cityList = [];

            var areaList = [];

            showP(provinceList);

            showC(cityList);

            showA(areaList);

            function showP(provinceList) {
                p.html('');

                is_pName = false;

                for (var i in provinceList) {

                    if (pName == provinceList[i].name) {
                        is_pName = true;
                        cityList = provinceList[i].cityList;
                        p.append("<option selected value='" + provinceList[i].name + "'>" + provinceList[i].name + "</option>")
                    } else {
                        p.append("<option value='" + provinceList[i].name + "'>" + provinceList[i].name + "</option>")
                    }
                }
                if (!is_pName) {
                    cityList = provinceList[0].cityList;
                }

            }

            function showC(cityList) {

                c.html('');

                is_cName = false;

                for (var i in cityList) {
                    if (cName == cityList[i].name) {
                        is_cName = true;
                        areaList = cityList[i].areaList;
                        c.append("<option selected value='" + cityList[i].name + "'>" + cityList[i].name + "</option>")

                    } else {
                        c.append("<option value='" + cityList[i].name + "'>" + cityList[i].name + "</option>")


                    }
                }

                if (!is_cName) {
                    areaList = cityList[0].areaList;
                }
            }

            function showA(areaList) {
                a.html('');

                for (var i in areaList) {

                    if (aName == areaList[i]) {
                        a.append("<option selected  value='" + areaList[i] + "'>" + areaList[i] + "</option>")
                    } else {
                        a.append("<option value='" + areaList[i] + "'>" + areaList[i] + "</option>")
                    }
                }
            }

            function showS(name,cityList) {
                fo.html('');
                for (var i in cityList){
                    if(name == cityList[i].name){

                        fo.append(cityList[i].info);

                    }else{
                        fo.append('')
                    }
                }
            }
            form.render('select');

            form.on('select(province)', function (data) {
                pName = data.value;
                showP(provinceList);
                showC(cityList);
                showA(areaList);
                form.render('select');
            });

            form.on('select(city)', function (data) {
                cName = data.value;

                showS(cName,cityList)
                form.render();
                showC(cityList);
                showA(areaList);
                form.render('select');
            });


        }
        var provinceList = [
            {% for foo in VC_list %}

                {
                    name: '{{ foo.type }}', cityList: [
                        {% for fo in foo.vulnerability %}
                            {name: '{{ fo.title }}', areaList: ['高', '中', '低'], info:'{{ fo.suggest }}'},
                        {% endfor %}



                    ]
                },
            {% endfor %}


        ]


        layui.use(['form', 'code'], function () {
            form = layui.form;
            layui.code();
            $('#x-city').xcity('{{ vclass.type }}', '', '');
        });
    </script>
    <script>

        $(function () {
            Simditor.locale = 'zh-CN';//设置中文
            var editor = new Simditor({
                textarea: $('#editor123'),  //textarea的id
                placeholder: '这里输入文字...',

                toolbar: ['title', 'bold', 'italic', 'underline', 'strikethrough', 'fontScale', 'color', '|', 'ol', 'ul', 'blockquote', 'code', 'table', '|', 'link', 'image', 'hr', '|', 'indent', 'outdent', 'alignment'], //工具条都包含哪些内容
                pasteImage: true,//允许粘贴图片
                defaultImage: '/res/simditor/images/image.png',//编辑器插入的默认图片，此处可以删除
                upload: {
                    url: '{{ url_for("imgupload") }}', //文件上传的接口地址
                    params: null, //键值对,指定文件上传接口的额外参数,上传的时候随文件一起提交
                    fileKey: 'upload_file', //服务器端获取文件数据的参数名
                    connectionCount: 3,
                    leaveConfirm: '正在上传文件'
                }
            });
           editor.uploader.on('uploadsuccess', (res,file,mask)= > {

            let img = file.img;
            console.log(res);
            console.log(file);//simditor的文件对象
            console.log(mask);//mask为后台接口地址返回来的参数

            if(mask.code===200){
                alert("上传成功");
                img.attr('src',"http://服务器图片路径.jpg");//重新给img标签的src属性赋值图片路径
            }else {
                alert("图片上传失败,请重新上传");
            }


        });



        layui.use('laydate', function () {
            var laydate = layui.laydate;
            //执行一个laydate实例
            laydate.render({
                elem: '#end' //指定元素
            });

            //执行一个laydate实例
            laydate.render({
                elem: '#start' //指定元素
            });
        });


        layui.use(['form', 'layer'], function () {
            $ = layui.jquery;
            var form = layui.form
                , layer = layui.layer;

            //自定义验证规则
            form.verify({
                nikename: function (value) {
                    if (value.length < 5) {
                        return '昵称至少得5个字符啊';
                    }
                }
                , pass: [/(.+){6,12}$/, '密码必须6到12位']
                , repass: function (value) {
                    if ($('#L_pass').val() != $('#L_repass').val()) {
                        return '两次密码不一致';
                    }
                }
            });

            //监听提交
            form.on('submit(add)', function (data) {
                console.log(data);

               $.ajax({
                    url: '{{ url_for('Vulnerabilityadd',pid=pid,vclassid=vclass.id,tid=tid) }}',
                    type: "POST",
                    data: data.field,
                    success: function (data) {
                        layer.alert("增加成功", {icon: 6}, function () {
                            // 获得frame索引
                            var index = parent.layer.getFrameIndex(window.name);
                            //关闭当前frame
                            parent.layer.close(index);
                        });
                    }
                });
                return false;
            });


        });
    </script>
{% endblock %}